"use strict";(self.webpackChunktask_master=self.webpackChunktask_master||[]).push([[6804],{56804:(hs,X,s)=>{s.d(X,{ReviewWorkflowsEditPage:()=>is});var t=s(19968),_=s(62552),Z=s(35676),L=s(48936),$=s(89296),T=s(63358),M=s(50648),b=s(53305),A=s(31812),q=s(14632),l=s(70516),ss=s(49008),ts=s(33531),os=s(17944),e=s(74172),es=s(31964),p=s(66942),ns=s(68396),h=s(24452),E=s(6484),I=s(1844),as=s(51728),cs=s(85240),Cs=s(13192),Ls=s(35184),Ts=s(52540),As=s(17892),Is=s(31212),Rs=s(85676),Ws=s(96556),Bs=s(54320),Us=s(5240),Ks=s(91892),us=s(36196),ws=s(20880),ys=s(21424),js=s(18424),ps=s(21968),Ss=s(12132),xs=s(48632),Fs=s(99568),zs=s(30840),ks=s(77784),Ys=s(79371),Ns=s(67888),Vs=s(52600),Hs=s(95752),Gs=s(37388),Js=s(61840),Qs=s(49108),Xs=s(44632),Zs=s(50840),$s=s(20252),bs=s(86432),qs=s(22612),st=s(24808),tt=s(24024),ot=s(40960),et=s(33656),nt=s(43280),at=s(79804),it=s(19632),lt=s(29576),_t=s(61152),rt=s(9589),Et=s(45488),dt=s(75516);const is=()=>{const{workflowId:R}=(0,ss.W4)(),ls=(0,l.w1)(es.s),{formatMessage:n}=(0,q.c)(),r=(0,l.OY)(),{_unstableFormatAPIError:_s,_unstableFormatValidationErrors:rs}=(0,M.An)(),D=(0,M.eo)(),{isLoading:O,meta:P,workflows:g}=(0,as.u)(),{collectionTypes:S,singleTypes:x,isLoading:W}=(0,os.u)(),Es=(0,l.w1)(e.j),ds=(0,l.w1)(e.a),a=(0,l.w1)(e.b),F=(0,l.w1)(e.k),z=(0,l.w1)(e.c),v=(0,l.w1)(e.s),{allowedActions:{canDelete:Ms,canUpdate:B}}=(0,M.aU)(ls.settings?.["review-workflows"]),[c,C]=_.useState({}),{getFeature:Ds,isLoading:k}=(0,p.m)(),{isLoading:U,roles:Y}=(0,ts.u)(void 0),[N,d]=_.useState(null),[Os,V]=_.useState(),[Ps,H]=_.useState(!1),K=g?.find(o=>o.id===parseInt(R,10)),G=g?.filter(o=>o.id!==parseInt(R,10)).flatMap(o=>o.contentTypes),u=Ds("review-workflows"),f=u?.[I.C],m=u?.[I.a],[gs]=(0,ns.e)(),J=async()=>{V(void 0),H(!0);try{const o=await gs({id:R,data:{...a,stages:a.stages?.map(i=>{let Q=!0;const y=Es.workflow?.stages?.find(j=>j.id===i?.id);return y&&(Q=y.permissions?.length!==i.permissions?.length||!y.permissions?.every(j=>!!i.permissions?.find(ms=>ms.role===j.role))),{...i,permissions:Q?i.permissions:void 0}})}});if("error"in o){(0,p.x)(o.error)&&o.error.name==="ValidationError"&&V(rs(o.error)),D({type:"warning",message:_s(o.error)});return}D({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}catch{D({type:"warning",message:{id:"notification.error",defaultMessage:"An error occurred"}})}finally{H(!1)}C({})},vs=async()=>{await J()},fs=()=>{C({})},w=(0,A.KO)({enableReinitialize:!0,initialErrors:Os,initialValues:a,async onSubmit(){const o=a.contentTypes?.some(i=>G?.includes(i));P&&f&&P?.workflowCount>parseInt(f,10)?d("workflow"):a.stages&&m&&a.stages.length>parseInt(m,10)?d("stage"):F||o?(F&&C(i=>({...i,hasDeletedServerStages:!0})),o&&C(i=>({...i,hasReassignedContentTypes:!0}))):J()},validate(o){return(0,e.v)({values:o,formatMessage:n})}});return(0,e.u)(I.R,e.i),_.useEffect(()=>(!O&&K&&g&&(r((0,e.l)({workflow:K})),r((0,e.d)({workflows:g}))),W||r((0,e.e)({collectionTypes:S,singleTypes:x})),U||r((0,e.f)(Y)),r((0,e.g)(O||W||U)),()=>{r((0,e.r)())}),[S,r,W,O,U,Y,x,K,g]),_.useEffect(()=>{!O&&!k&&(P&&f&&P?.workflowCount>parseInt(f,10)?d("workflow"):a.stages&&m&&a.stages.length>parseInt(m,10)&&d("stage"))},[a.stages,k,O,u,P,f,m]),_.useEffect(()=>{!v&&z?.length===0&&D({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,v,z,D]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.D,{}),(0,t.jsx)(A.uo,{value:w,children:(0,t.jsxs)(A.QF,{onSubmit:w.handleSubmit,children:[(0,t.jsx)(h.H,{navigationAction:(0,t.jsx)(h.B,{href:"/settings/review-workflows"}),primaryAction:B&&(0,t.jsx)(Z.Z,{startIcon:(0,t.jsx)(b.c,{}),type:"submit",size:"M",disabled:!ds,loading:!Boolean(Object.keys(c).length>0)&&Ps,children:n({id:"global.save",defaultMessage:"Save"})}),subtitle:!v&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:a.stages?.length}),title:a.name||""}),(0,t.jsx)(h.R,{children:v?(0,t.jsx)(L.C,{justifyContent:"center",children:(0,t.jsx)($.c,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,t.jsxs)(L.C,{alignItems:"stretch",direction:"column",gap:7,children:[(0,t.jsx)(e.W,{canUpdate:B}),(0,t.jsx)(e.S,{canDelete:Ms,canUpdate:B,stages:w.values?.stages})]})})]})}),(0,t.jsx)(M.cz.Root,{isConfirmButtonLoading:v,isOpen:Object.keys(c).length>0,onToggleDialog:fs,onConfirm:vs,children:(0,t.jsx)(M.cz.Body,{children:(0,t.jsxs)(L.C,{direction:"column",gap:5,children:[c.hasDeletedServerStages&&(0,t.jsx)(T.O,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),c.hasReassignedContentTypes&&(0,t.jsx)(T.O,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:G?.filter(o=>a.contentTypes?.includes(o)).length})}),(0,t.jsx)(T.O,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,t.jsxs)(E.L.Root,{isOpen:N==="workflow",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,t.jsxs)(E.L.Root,{isOpen:N==="stage",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}}}]);
